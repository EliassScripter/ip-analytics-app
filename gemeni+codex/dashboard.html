<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; }
        .table-container { max-height: 400px; overflow-y: auto; }
        .hostname-col { max-width: 200px; word-wrap: break-word; }
        
        /* Map Container Size */
        #map { height: 400px; width: 100%; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Traffic Analytics</h1>

        <!-- Manual IP Lookup -->
        <div class="card">
            <div class="card-header">Manual IP Lookup</div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="manualIpInput" class="form-control" placeholder="Enter IP Address (e.g., 8.8.8.8)">
                    <button class="btn btn-primary" type="button" onclick="lookupIp()">Lookup</button>
                </div>
                <div id="lookupError" class="alert alert-danger d-none"></div>
                <div id="lookupResult" class="d-none">
                    <p><strong>Location:</strong> <span id="resLocation"></span></p>
                    <p><strong>Hostname:</strong> <span id="resHostname"></span></p>
                    <p><strong>Subnet:</strong> <span id="resNetwork"></span></p>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="card">
            <div class="card-header bg-dark text-white">Geographic Distribution</div>
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
            <div class="card-footer text-muted small">
                Circles represent visitor locations. Size (Magnitude) indicates traffic volume.
            </div>
        </div>

        <!-- Traffic Chart -->
        <div class="card">
            <div class="card-header">Traffic Over Time (Visits per Hour)</div>
            <div class="card-body">
                <canvas id="trafficChart" style="max-height: 300px;"></canvas>
            </div>
        </div>


        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">Top Recurring IPs</div>
                    <div class="card-body">
                        <ul class="list-group">
                            {% for ip, count in ip_counts.most_common(5) %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ ip }}
                                <span class="badge bg-primary rounded-pill">{{ count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">Top Subnets</div>
                    <div class="card-body">
                        <ul class="list-group">
                            {% for subnet, count in subnet_counts.most_common(5) %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ subnet }}
                                <span class="badge bg-success rounded-pill">{{ count }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Logs Table -->
        <div class="card">
            <div class="card-header">Detailed Access Logs</div>
            <div class="card-body table-container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>IP Address</th>
                            <th>Location</th>
                            <th>Hostname</th>
                            <th>Subnet</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs|reverse %}
                        <tr>
                            <td>{{ log.timestamp }}</td>
                            <td>{{ log.ip }}</td>
                            <td>
                                {% if log.geo %}
                                    {{ log.geo.city }}, {{ log.geo.country }}
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td class="hostname-col">
                                <small>{{ log.hostname }}</small>
                            </td>
                            <td>
                                {% if log.network_info %}
                                    {{ log.network_info.network }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize Map
        var map = L.map('map').setView([20, 0], 2); // Start with a world view

        // Add OpenStreetMap Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Load Data from Flask
        var mapPoints = {{ map_points | tojson }};

        // Loop through points and add circles
        mapPoints.forEach(function(point) {
            // Magnitude: Base radius + (count * multiplier)
            // We use a Circle instead of a Marker to show "Magnitude" via size
            var radius = 50000 + (point.count * 50000); 

            L.circle([point.lat, point.lon], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: radius
            }).addTo(map)
            .bindPopup(`<b>${point.city}, ${point.country}</b><br>Visits: ${point.count}`);
        });

        // Manual Lookup Function
        function lookupIp() {
            const ip = document.getElementById('manualIpInput').value.trim();
            const errorDiv = document.getElementById('lookupError');
            const resultDiv = document.getElementById('lookupResult');

            // Reset UI
            errorDiv.classList.add('d-none');
            resultDiv.classList.add('d-none');

            if (!ip) return;

            fetch('/lookup-ip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip: ip })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Lookup failed'); });
                }
                return response.json();
            })
            .then(data => {
                resultDiv.classList.remove('d-none');
                
                // Update Text Info
                const loc = data.geo ? `${data.geo.city}, ${data.geo.country}` : "Unknown";
                document.getElementById('resLocation').innerText = loc;
                document.getElementById('resHostname').innerText = data.hostname;
                document.getElementById('resNetwork').innerText = data.network_info ? data.network_info.network : "N/A";

                // Update Map if location found
                if (
                    data.geo &&
                    data.geo.lat !== null &&
                    data.geo.lat !== undefined &&
                    data.geo.lon !== null &&
                    data.geo.lon !== undefined
                ) {
                    L.marker([data.geo.lat, data.geo.lon]).addTo(map)
                        .bindPopup(`<b>${data.ip}</b><br>${loc}`)
                        .openPopup();
                    map.setView([data.geo.lat, data.geo.lon], 10);
                }
            })
            .catch(err => {
                errorDiv.innerText = err.message;
                errorDiv.classList.remove('d-none');
            });
        }

        // Initialize Traffic Chart
        var ctx = document.getElementById('trafficChart').getContext('2d');
        var trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels | tojson }},
                datasets: [{
                    label: 'Visits',
                    data: {{ chart_data | tojson }},
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    </script>
    <div class="text-center mb-4">
        <a href="/export-csv" class="btn btn-success">Export to CSV</a>
    </div>
</body>
</html>
